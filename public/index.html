<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hnefatafl Debug UI</title>
    <style>
    body {
        background-color: #1e1e1e;
        color: #ddd;
        font-family: sans-serif;
        padding: 0.125rem;
    }

    .board {
        display: grid;
        grid-template-columns: repeat(11, 2rem);
        column-gap: 0.1rem;
    }

    .cell {
        width: 2rem;
        height: 2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid #444;
        border-radius: 0.1rem;
        cursor: pointer;
        background-color: #2c2c2c;
        color: #fff;
    }

    .cell:hover {
        background-color: #3a3a3a;
    }

    .throne {
        background-color: #5a5617 !important;
    }

    .corner {
        background-color: #520000 !important;
    }

    .info, .side-panel {
        margin-bottom: 0.5rem;
    }

    .side-panel > div {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .side-panel ul {
        flex: 1 1 auto;
        overflow: auto;
        height: 10rem;
    }

    input {
        margin-right: 5px;
        background-color: #2a2a2a;
        color: #fff;
        border: 1px solid #555;
        padding: 4px;
    }

    button {
        margin-right: 5px;
        background-color: #333;
        color: #fff;
        border: 1px solid #666;
        padding: 4px 8px;
        cursor: pointer;
    }

    button:hover {
        background-color: #444;
    }

    pre {
        background: #2b2b2b;
        color: #eee;
        padding: 10px;
        height: 150px;
        overflow: auto;
        border: 1px solid #444;
    }

    ul {
        margin: 0;
        padding: 0;
        max-height: 10rem;
        overflow: auto;
    }

    li {
        padding: 4px 6px;
        border-bottom: 1px solid #444;
        font-family: monospace;
    }

    li:hover {
        background-color: #333;
    }
    </style>
</head>
<body>
    <h1>Hnefatafl Debug UI</h1>

    <div id="boardcontainer" style="display: flex; flex-direction: row; gap: 20px;">
        <div id="board" class="board"></div>
        <div class="side-panel" style="display: flex; gap: 20px; align-items: flex-start;">
            <div style="flex: 1;">
                <h3>Current Game</h3>
                <button id="copyGame">Copy Game</button>
                <ul id="currentMoves" style="list-style: none; padding: 0; border: 1px solid #ccc;"></ul>
            </div>
            <div style="flex: 1;">
                <h3>Load Game</h3>
                <div style="display: flex;flex-direction: row">
                    <input id="notationInput" placeholder="Enter game notation string" style="width: 100%; margin-bottom: 5px;">
                    <button id="loadBtn">Load</button>
                </div>
                <ul id="loadedMoves" style="list-style: none; padding: 0; border: 1px solid #ccc;"></ul>
            </div>
        </div>
    </div>

    <div class="info">
        <input id="fromInput" placeholder="From (e.g. E5)">
        <input id="toInput" placeholder="To (e.g. E6)">
        <input id="captureInput" placeholder="Capture (e.g. D5F5)">
        <button id="clearBtn">Clear</button>
        <button id="validateBtn">Validate</button>
        <button id="applyBtn">Apply</button>
    </div>

    <div class="info">
        <div>Current Player: <span id="currentPlayer"></span></div>
        <div>Captured: A: <span id="capturedA"></span>, D: <span id="capturedD"></span></div>
        <div>Status: <span id="gameStatus"></span></div>
    </div>

    <pre id="log"></pre>

    <script type="module">
        import { HnefataflEngine } from '../src/HnefataflEngine.js';
        import { parseMove, parseMoveSequence } from '../src/parser.js';

        const boardEl = document.getElementById('board');
        const fromInput = document.getElementById('fromInput');
        const toInput = document.getElementById('toInput');
        const captureInput = document.getElementById('captureInput');
        const validateBtn = document.getElementById('validateBtn');
        const applyBtn = document.getElementById('applyBtn');
        const clearBtn = document.getElementById('clearBtn');
        const logEl = document.getElementById('log');
        const currentPlayerEl = document.getElementById('currentPlayer');
        const capturedAEl = document.getElementById('capturedA');
        const capturedDEl = document.getElementById('capturedD');
        const gameStatusEl = document.getElementById('gameStatus');
        const currentMovesList = document.getElementById('currentMoves');
        const loadedMovesList = document.getElementById('loadedMoves');
        const notationInput = document.getElementById('notationInput');
        const loadBtn = document.getElementById('loadBtn');
        const copyGameBtn = document.getElementById('copyGame');

        const engine = new HnefataflEngine();

        function coordToString(x, y) {
            return String.fromCharCode(65 + x) + (11 - y);
        }

        function renderMoveList(listEl, moves) {
            listEl.innerHTML = '';
            let player = 'defender';
            for (const move of moves) {
                const li = document.createElement('li');
                const prefix = player === 'defender' ? 'D' : 'A';
                if (move === 'pass') {
                    li.textContent = `${prefix}: P`;
                } else {
                    const from = coordToString(move.from.x, move.from.y);
                    const to = coordToString(move.to.x, move.to.y);
                    const caps = move.captures.length ? `(${move.captures.map(c => coordToString(c.x, c.y)).join('')})` : '';
                    li.textContent = `${prefix}: ${from}-${to}${caps}`;
                    li.style.cursor = 'pointer';
                    li.onclick = () => {
                        fromInput.value = from;
                        toInput.value = to;
                        captureInput.value = move.captures.map(c => coordToString(c.x, c.y)).join('');
                    };
                }
                listEl.appendChild(li);
                player = player === 'defender' ? 'attacker' : 'defender';
            }
        }

        function render() {
            const state = engine.getState();
            boardEl.innerHTML = '';

            state.board.forEach((row, y) => {
                row.forEach((cell, x) => {
                    const div = document.createElement('div');
                    div.className = 'cell';
                    if (cell.isThrone) div.classList.add('throne')
                    else if (cell.isRestricted) div.classList.add('corner');
                    if (cell.occupant) {
                        if (cell.occupant.type === 'attacker') div.textContent = 'A';
                        else if (cell.occupant.type === 'defender') div.textContent = 'D';
                        else if (cell.occupant.type === 'king') div.textContent = 'K';
                        else div.textContent = '';
                    } else {
                        div.textContent = '';
                    }
                    div.addEventListener('click', () => {
                        const coord = coordToString(x, y);
                        if (!fromInput.value)
                            fromInput.value = coord;
                        else if (!toInput.value)
                            toInput.value = coord;
                        else if (!captureInput.value)
                            captureInput.value = coord;
                    });
                    boardEl.appendChild(div);
                });
            });

            currentPlayerEl.textContent = state.currentPlayer;
            capturedAEl.textContent = state.captured.attacker;
            capturedDEl.textContent = state.captured.defender;
            gameStatusEl.textContent = state.status;

            const parsedMoves = state.moveHistory.map((str) => {
                if (str === 'P') return 'pass';
                const move = parseMove(str);
                return move ? move : 'pass';
            });

            renderMoveList(currentMovesList, parsedMoves);
        }

        validateBtn.onclick = () => {
            const move = `${fromInput.value}-${toInput.value}${captureInput.value ? `(${captureInput.value})` : ''}`;
            const result = engine.validateMove(move);
            logEl.textContent = JSON.stringify(result, null, 2);
        };

        applyBtn.onclick = () => {
            const move = `${fromInput.value}-${toInput.value}${captureInput.value ? `(${captureInput.value})` : ''}`;
            const result = engine.applyMove(move);
            logEl.textContent = JSON.stringify(result, null, 2);
            if (result.success) {
                fromInput.value = '';
                toInput.value = '';
                captureInput.value = '';
                render();
            } else {
                fromInput.value = '';
                toInput.value = '';
                captureInput.value = '';
            }
        };

        clearBtn.onclick = () => {
            fromInput.value = '';
            toInput.value = '';
            captureInput.value = '';
        };

        loadBtn.onclick = () => {
            const input = notationInput.value;
            const parsed = parseMoveSequence(input);
            renderMoveList(loadedMovesList, parsed);
        };

        copyGameBtn.onclick = () => {
            const moveHistory = engine.getState().moveHistory;
            navigator.clipboard.writeText(moveHistory.join(', ')).then(() => {
                alert('Game copied to clipboard!');
            });
        };

        engine.reset();
        render();
    </script>

</body>
</html>
