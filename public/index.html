<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hnefatafl Debug UI</title>
    <style>
    body {
        background-color: #1e1e1e;
        color: #ddd;
        font-family: sans-serif;
        padding: 0.125rem;
    }

    .board {
        display: grid;
        grid-template-columns: repeat(11, 2rem);
        column-gap: 0.1rem;
    }

    .cell {
        width: 2rem;
        height: 2rem;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid #444;
        border-radius: 0.1rem;
        cursor: pointer;
        background-color: #2c2c2c;
        color: #fff;
    }

    .cell:hover {
        background-color: #3a3a3a;
    }

    .throne {
        background-color: #5a5617 !important;
    }

    .corner {
        background-color: #520000 !important;
    }

    .info, .side-panel {
        margin-bottom: 0.5rem;
    }

    .side-panel > div {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .side-panel ul {
        flex: 1 1 auto;
        overflow: auto;
        height: 10rem;
    }

    input {
        margin-right: 5px;
        background-color: #2a2a2a;
        color: #fff;
        border: 1px solid #555;
        padding: 4px;
    }

    button {
        margin-right: 5px;
        background-color: #333;
        color: #fff;
        border: 1px solid #666;
        padding: 4px 8px;
        cursor: pointer;
    }

    button:hover {
        background-color: #444;
    }

    pre {
        background: #2b2b2b;
        color: #eee;
        padding: 10px;
        height: 150px;
        overflow: auto;
        border: 1px solid #444;
    }

    ul {
        margin: 0;
        padding: 0;
        max-height: 10rem;
        overflow: auto;
    }

    li {
        padding: 4px 6px;
        border-bottom: 1px solid #444;
        font-family: monospace;
    }

    li:hover {
        background-color: #333;
    }

    .cell.highlight-possible {
        background-color: #4a5a3a !important;
        border: 2px solid #6a8a4a !important;
    }

    .cell.highlight-capture {
        background-color: #5a3a3a !important;
        border: 2px solid #8a4a4a !important;
    }

    .cell.highlight-selected {
        background-color: #3a4a5a !important;
        border: 2px solid #4a6a8a !important;
    }
    </style>
</head>
<body>
    <h1>Hnefatafl Debug UI</h1>

    <div id="boardcontainer" style="display: flex; flex-direction: row; gap: 20px;">
        <div id="board" class="board"></div>
        <div class="side-panel" style="display: flex; gap: 20px; align-items: flex-start;">
            <div style="flex: 1;">
                <h3>Current Game</h3>
                <button id="copyGame">Copy Game</button>
                <ul id="currentMoves" style="list-style: none; padding: 0; border: 1px solid #ccc;"></ul>
            </div>
            <div style="flex: 1;">
                <h3>Load Game</h3>
                <div style="display: flex;flex-direction: row">
                    <input id="notationInput" placeholder="Enter game notation string" style="width: 100%; margin-bottom: 5px;">
                    <button id="loadBtn">Load</button>
                </div>
                <ul id="loadedMoves" style="list-style: none; padding: 0; border: 1px solid #ccc;"></ul>
            </div>
        </div>
    </div>

    <div class="info">
        <input id="fromInput" placeholder="From (e.g. E5)">
        <input id="toInput" placeholder="To (e.g. E6)">
        <button id="clearBtn">Clear</button>
        <button id="validateBtn">Validate</button>
        <button id="applyBtn">Apply</button>
    </div>

    <div class="info">
        <div>Current Player: <span id="currentPlayer"></span></div>
        <div>Captured: A: <span id="capturedA"></span>, D: <span id="capturedD"></span></div>
        <div>Status: <span id="gameStatus"></span></div>
    </div>

    <pre id="log"></pre>

    <script type="module">
        import { HnefataflEngine } from '../src/HnefataflEngine.js';
        import { parseMove, parseMoveSequence } from '../src/parser.js';

        const boardEl = document.getElementById('board');
        const fromInput = document.getElementById('fromInput');
        const toInput = document.getElementById('toInput');
        const validateBtn = document.getElementById('validateBtn');
        const applyBtn = document.getElementById('applyBtn');
        const clearBtn = document.getElementById('clearBtn');
        const logEl = document.getElementById('log');
        const currentPlayerEl = document.getElementById('currentPlayer');
        const capturedAEl = document.getElementById('capturedA');
        const capturedDEl = document.getElementById('capturedD');
        const gameStatusEl = document.getElementById('gameStatus');
        const currentMovesList = document.getElementById('currentMoves');
        const loadedMovesList = document.getElementById('loadedMoves');
        const notationInput = document.getElementById('notationInput');
        const loadBtn = document.getElementById('loadBtn');
        const copyGameBtn = document.getElementById('copyGame');

        const engine = new HnefataflEngine();
        
        // Track UI state for move highlighting
        let selectedFrom = null;
        let possibleMoves = [];
        let currentHighlights = [];

        function coordToString(x, y) {
            return String.fromCharCode(65 + x) + (11 - y);
        }

        function stringToCoord(str) {
            if (!str || str.length !== 2) return null;
            const x = str.charCodeAt(0) - 65;
            const y = 11 - parseInt(str.charAt(1));
            return { x, y };
        }

        function clearHighlights() {
            currentHighlights.forEach(cell => {
                cell.classList.remove('highlight-possible', 'highlight-capture', 'highlight-selected');
            });
            currentHighlights = [];
        }

        function highlightPossibleMoves(from) {
            clearHighlights();
            possibleMoves = engine.getPossibleMoves(from);
            
            // Highlight the selected piece
            const fromCell = boardEl.children[from.y * 11 + from.x];
            fromCell.classList.add('highlight-selected');
            currentHighlights.push(fromCell);
            
            // Highlight possible target squares and captures
            possibleMoves.forEach(move => {
                const toCell = boardEl.children[move.to.y * 11 + move.to.x];
                toCell.classList.add('highlight-possible');
                currentHighlights.push(toCell);
                
                // Highlight pieces that would be captured
                move.captures.forEach(capture => {
                    const captureCell = boardEl.children[capture.y * 11 + capture.x];
                    captureCell.classList.add('highlight-capture');
                    currentHighlights.push(captureCell);
                });
            });
        }

        function renderMoveList(listEl, moves) {
            listEl.innerHTML = '';
            let player = 'defender';
            for (const move of moves) {
                const li = document.createElement('li');
                const prefix = player === 'defender' ? 'D' : 'A';
                if (move === 'pass') {
                    li.textContent = `${prefix}: P`;
                } else {
                    const from = coordToString(move.from.x, move.from.y);
                    const to = coordToString(move.to.x, move.to.y);
                    const caps = move.captures.length ? `(${move.captures.map(c => coordToString(c.x, c.y)).join('')})` : '';
                    li.textContent = `${prefix}: ${from}-${to}${caps}`;
                    li.style.cursor = 'pointer';
                    li.onclick = () => {
                        fromInput.value = from;
                        toInput.value = to;
                    };
                }
                listEl.appendChild(li);
                player = player === 'defender' ? 'attacker' : 'defender';
            }
        }

        function render() {
            const state = engine.getState();
            boardEl.innerHTML = '';

            state.position.forEach((row, y) => {
                row.forEach((square, x) => {
                    const div = document.createElement('div');
                    div.className = 'cell';
                    if (square.isThrone) div.classList.add('throne')
                    else if (square.isRestricted) div.classList.add('corner');
                    if (square.occupant) {
                        if (square.occupant.type === 'attacker') div.textContent = 'A';
                        else if (square.occupant.type === 'defender') div.textContent = 'D';
                        else if (square.occupant.type === 'king') div.textContent = 'K';
                        else div.textContent = '';
                    } else {
                        div.textContent = '';
                    }
                    div.addEventListener('click', () => {
                        const coord = { x, y };
                        const coordStr = coordToString(x, y);
                        
                        if (!selectedFrom) {
                            // First click - select a piece if it belongs to current player
                            if (square.occupant && (
                                square.occupant.owner === state.currentPlayer ||
                                (state.currentPlayer === 'defender' && square.occupant.type === 'king')
                            )) {
                                selectedFrom = coord;
                                fromInput.value = coordStr;
                                toInput.value = '';
                                highlightPossibleMoves(coord);
                            }
                        } else {
                            // Second click - either select target or change selection
                            if (square.occupant && (
                                square.occupant.owner === state.currentPlayer ||
                                (state.currentPlayer === 'defender' && square.occupant.type === 'king')
                            )) {
                                // Clicking another piece - change selection
                                selectedFrom = coord;
                                fromInput.value = coordStr;
                                toInput.value = '';
                                highlightPossibleMoves(coord);
                            } else {
                                // Clicking empty square or opponent piece - try to move here
                                const isPossibleMove = possibleMoves.some(move => 
                                    move.to.x === x && move.to.y === y
                                );
                                
                                if (isPossibleMove) {
                                    toInput.value = coordStr;
                                    // Keep only the highlights for this specific move
                                    clearHighlights();
                                    const fromCell = boardEl.children[selectedFrom.y * 11 + selectedFrom.x];
                                    fromCell.classList.add('highlight-selected');
                                    currentHighlights.push(fromCell);
                                    
                                    const toCell = boardEl.children[y * 11 + x];
                                    toCell.classList.add('highlight-possible');
                                    currentHighlights.push(toCell);
                                    
                                    // Highlight only the captures for this specific move
                                    const selectedMove = possibleMoves.find(move => 
                                        move.to.x === x && move.to.y === y
                                    );
                                    if (selectedMove) {
                                        selectedMove.captures.forEach(capture => {
                                            const captureCell = boardEl.children[capture.y * 11 + capture.x];
                                            captureCell.classList.add('highlight-capture');
                                            currentHighlights.push(captureCell);
                                        });
                                    }
                                } else {
                                    // Invalid target - clear selection
                                    selectedFrom = null;
                                    possibleMoves = [];
                                    fromInput.value = '';
                                    toInput.value = '';
                                    clearHighlights();
                                }
                            }
                        }
                    });
                    boardEl.appendChild(div);
                });
            });

            currentPlayerEl.textContent = state.currentPlayer;
            capturedAEl.textContent = state.captured.attacker;
            capturedDEl.textContent = state.captured.defender;
            gameStatusEl.textContent = state.status;

            const parsedMoves = state.moveHistory.map((str) => {
                if (str === 'P') return 'pass';
                const move = parseMove(str);
                return move ? move : 'pass';
            });

            renderMoveList(currentMovesList, parsedMoves);
        }

        validateBtn.onclick = () => {
            const move = `${fromInput.value}-${toInput.value}`;
            const result = engine.validateMove(move);
            
            // If there are captures available, display them in the log
            if (result.expectedCaptures && result.expectedCaptures.length > 0) {
                const captureNotation = result.expectedCaptures.map(c => coordToString(c.x, c.y)).join('');
                logEl.textContent = `${JSON.stringify(result, null, 2)}\n\nCaptures: ${captureNotation}`;
            } else {
                logEl.textContent = JSON.stringify(result, null, 2);
            }
        };

        applyBtn.onclick = () => {
            const move = `${fromInput.value}-${toInput.value}`;
            const result = engine.applyMove(move);
            logEl.textContent = JSON.stringify(result, null, 2);
            if (result.success) {
                // Clear selection and highlights after successful move
                selectedFrom = null;
                possibleMoves = [];
                fromInput.value = '';
                toInput.value = '';
                clearHighlights();
                render();
            } else {
                fromInput.value = '';
                toInput.value = '';
            }
        };

        clearBtn.onclick = () => {
            selectedFrom = null;
            possibleMoves = [];
            fromInput.value = '';
            toInput.value = '';
            clearHighlights();
        };

        loadBtn.onclick = () => {
            const input = notationInput.value;
            const parsed = parseMoveSequence(input);
            renderMoveList(loadedMovesList, parsed);
        };

        copyGameBtn.onclick = () => {
            const moveHistory = engine.getState().moveHistory;
            navigator.clipboard.writeText(moveHistory.join(', ')).then(() => {
                alert('Game copied to clipboard!');
            });
        };

        engine.reset();
        render();
    </script>

</body>
</html>
